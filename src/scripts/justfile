set shell := ["bash", "-uc"]
name := shell("yq .name src/model/*.linkml.yml | tr '-' '_'")
title := shell("yq .title ./src/model/*.linkml.yml")
version := shell("yq .version ./src/model/*.linkml.yml")
site_title := shell("yq .title src/model/*.linkml.yml")

_default:
    @just --list --unsorted --justfile {{justfile()}}

# Cleans the output directory
_clean:
    #!/bin/bash
    set -e
    echo "Cleaning up…"
    echo
    if [ -d output ]; then \
        rm -rf output; \
    fi
    echo "… OK."
    echo

# Build and serve website locally
[group("development")]
build-and-serve: build serve

_generate_asciidoc:
    #!/bin/bash
    set -e
    echo -e "Generating documentation (AsciiDoc)…"
    mkdir -p output/docs/adoc
    cp -r src/docs/* output/docs/adoc
    yq -i '.version = "{{version}}"' output/docs/adoc/antora.yml
    yq -i '.title = "{{title}}"' output/docs/adoc/antora.yml
    echo
    echo "Generating schema documentation…"
    echo
    mkdir -p "output/docs/adoc/modules/schema"
    python -m linkml_asciidoc_generator.main \
        -o output/docs/adoc/modules/schema \
        -t /opt/dataproducten/templates \
        --render-diagrams \
        src/model/{{name}}.linkml.yml
    echo "Adding schema documentation to nav…"
    yq -i '.nav += ["modules/schema/nav.adoc"]' output/docs/adoc/antora.yml
    echo

_generate_additional_schemas:
    #!/bin/bash
    set -e
    echo -e "Generating artifacts…"

    for schema in $(yq '.annotations.additional_schemas // ""' src/model/*.linkml.yml); do \
        if [ $schema == "json-schema" ]; then
            echo "Generating JSON Schema…"
            mkdir -p output/schemas/json-schema
            echo
            gen-json-schema \
                --not-closed \
                src/model/{{name}}.linkml.yml \
                > output/schemas/json-schema/{{name}}.json_schema.json
            echo "… OK."
            echo
            echo "Generated JSON Schema at: output/schemas/json-schema/{{name}}.json_schema.json"
            echo
            cp output/schemas/json-schema/{{name}}.json_schema.json output/docs/adoc/modules/schema/attachments/
        fi
        cp -r output/schemas/json-schema/{{name}}.json_schema.json output/docs/adoc/modules/schema/attachments/; \
        echo -e "To reference use:\n\txref:schema:attachment\$$schema[]"; \
    done

_generate_json_examples:
    #!/bin/bash
    set -e
    echo -e "Copy examples (JSON) to schema documentation…"
    for example in src/examples/*.yml; do \
        example_name=$(basename $example); \
        gen-linkml-profile  \
            convert \
            "$example" \
            --out "output/docs/adoc/modules/schema/attachments/${example_name%.*}.json"; \
        echo -e "To reference use:\n\txref:schema:attachment\$${example_name%.*}.json[]"; \
    done
    echo

# Generate and assemble
[group("development"),private]
generate-and-assemble: _clean validate-examples _generate_asciidoc _generate_additional_schemas _generate_json_examples

# Build website locally
[group("development")]
build: 
    @echo "Generating site using Antora…"
    @if [ $CI == "true"  ]; then \
        jinja -D site_url https://modellen.netbeheernederland.nl/{{name}} -D site_title {{site_title}} /opt/dataproducten/antora/antora-playbook.yml.jinja > /tmp/antora-playbook.yml; \
        antora --fetch /tmp/antora-playbook.yml; \
    else \
        jinja -D site_url http://localhost:8080 -D site_title {{site_title}} /opt/dataproducten/antora/antora-playbook.local.yml.jinja > /tmp/antora-playbook.local.yml; \
        antora --fetch /tmp/antora-playbook.local.yml; \
    fi
    @echo
    @echo -e "Generated documentation files at: output/docs/html"
    @echo

# Serve the built website locally
[group("development")]
serve:
    @echo -e "Serving website from output/docs/html…"
    @echo
    http-serve output/docs/html


# Release new major version
[group("version-control")]
release-major-version:
    @echo TODO…


# Release new minor version
[group("version-control")]
release-minor-version:
    @echo TODO…


# Submit for review to accept changes
[group("version-control")]
submit-for-review:
    @echo TODO…


# Validate example data against schema
[group("development")]
validate-examples:
    @echo -e "Validating example data…"
    linkml-validate -s src/model/*.linkml.yml src/examples/*
